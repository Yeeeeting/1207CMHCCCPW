<!DOCTYPE html>
<html lang="zh-Hant" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>(CCC)臨床能力委員會實務工作坊報名</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- 自訂 Tailwind 主題 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        'deep-blue': '#0A3B5C',      // 主標題深藍色
                        'secondary-blue': '#1E5F8A', // 次要標題/標籤
                        'brick-red': '#C64E35',     // 強調/按鈕
                        'light-khaki': '#E9DCC5',   // 區塊背景/點綴
                        'off-white': '#F8F6F2',    // 頁面主背景
                        'dark-text': '#2D2D2D',      // 深色內文
                    }
                }
            }
        }
    </script>
    
    <!-- 自訂表單元素樣式 -->
    <style>
        input[type="text"],
        input[type="email"],
        select {
            width: 100%;
            border: 1px solid #1E5F8A; /* border-secondary-blue */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem; /* p-2 */
        }

        /* [修改] 禁用時的樣式 */
        input:disabled,
        select:disabled,
        button:disabled {
            background-color: #e9ecef; /* 接近 gray-200 */
            opacity: 0.7;
            cursor: not-allowed;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        select:focus {
            border-color: #C64E35; /* focus:border-brick-red */
            box-shadow: 0 0 0 3px rgba(198, 78, 53, 0.25); /* focus:ring focus:ring-brick-red focus:ring-opacity-25 */
            outline: 2px solid transparent;
            outline-offset: 2px;
        }

        input[type="radio"],
        input[type="checkbox"] {
            @apply h-4 w-4 text-brick-red border-gray-400 focus:ring-brick-red;
        }

        :root {
            scroll-padding-top: 150px; 
        }
    </style>
</head>

<body class="bg-off-white font-sans text-dark-text antialiased">

    <!-- [新增] PGY 模式的浮動提示框 (Toast) -->
    <div id="toast-container" class="fixed inset-x-0 top-4 z-50 flex justify-center pointer-events-none">
        <div id="toast-box" class="p-4 rounded-xl font-bold transition-all duration-300 transform translate-y-[-150%] opacity-0 shadow-2xl min-w-[300px] text-center"></div>
    </div>

    <!-- 
      固定在頂部的容器 (標題 + 導覽列)
    -->
    <div class="sticky top-0 z-50 shadow-lg rounded-b-xl">
        
        <!-- 1. 標題區塊 -->
        <header class="bg-deep-blue text-white h-20 flex items-center justify-center px-4">
            <h1 class="text-2xl sm:text-3xl font-bold tracking-wider text-center">
                (CCC)臨床能力委員會實務工作坊
            </h1>
        </header>

        <!-- 2. 導覽列區塊 -->
        <nav class="bg-light-khaki">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-center items-center h-16">
                    <div class="space-x-10">
                        <a href="#info" data-navlink="info" class="font-bold text-secondary-blue hover:text-brick-red transition-colors duration-200 pb-1">活動資訊</a>
                        <a href="#register" data-navlink="register" class="font-bold text-secondary-blue hover:text-brick-red transition-colors duration-200 pb-1">線上報名</a>
                        <a href="#agenda" data-navlink="agenda" class="font-bold text-secondary-blue hover:text-brick-red transition-colors duration-200 pb-1">活動議程</a>
                    </div>
                </div>
            </div>
        </nav>
    </div>

    <!-- 主要內容容器 -->
    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        
        <div class="space-y-12">

            <!-- 
              區塊 1: 活動資訊 
            -->
            <div id="info" class="bg-white rounded-xl shadow-md overflow-hidden p-6 sm:p-8">
                <h2 class="text-3xl font-bold tracking-tight text-secondary-blue mb-6">活動資訊</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6 text-base">
                    <!-- 左側：目的與目標 -->
                    <div class="md:col-span-2 space-y-5">
                        <div>
                            <h3 class="text-xl font-semibold text-deep-blue mb-2">目的</h3>
                            <p class="text-gray-700 leading-relaxed">
                                本次工作坊邀請臺大醫院楊志偉醫師指導，以CCC（Clinical Competency Committee，臨床能力評估委員會）之運作為主軸，強調信賴評定是以病人安全為核心的風險判斷而非單純分數評量，並同步培育院內種子教師，建立可複製的會議模式至回饋流程，整體主要分為下列三個目標：
                            </p>
                            <ul class="list-decimal list-inside text-gray-700 leading-relaxed mt-3 space-y-1 pl-2">
                                <li>目標一 熟悉信賴決策(CCC運作模式)：讓教師們熟悉如何進行CCC會議，包括如何開會、促進討論、委員組成及下達信賴決CE等。</li>
                                <li>目標二 制定補強計畫(Remediation Plan)：根據CCC討論結果制定針對學員的客製化補強計畫(Tailor-made program design and remediation)。</li>
                                <li>目標三 (ADAPT)演練回饋技巧：如何對學員進行補強計劃和CCC評定結果的回饋模板演練。</li>
                            </ul>
                        </div>
                        
                        <!-- 學分區塊 -->
                        <div>
                            <h3 class="text-xl font-semibold text-deep-blue mb-2">學分</h3>
                            <p class="text-gray-700 leading-relaxed">
                                全程參與臨床教師認證C類教學技巧5學分、進階2分
                            </p>
                        </div>
                    </div>
                    
                    <!-- 右側：詳細資訊 -->
                    <div class="md:col-span-1 bg-light-khaki bg-opacity-60 rounded-lg p-5 space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-deep-blue">日期</h3>
                            <p class="text-gray-700">2025年12月7日 (日)</p>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-deep-blue">時間</h3>
                            <p class="text-gray-700">09:00 - 16:00 (08:45 開始報到)</p>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-deep-blue">地點</h3>
                            <p class="text-gray-700">第五醫療大樓五樓國際會議廳、552會議室、554會議室、556會議室、558會議室</p>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-deep-blue">講師</h3>
                            <p class="text-gray-700">臺大醫院 楊志偉 醫師</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 
              區塊 2: 線上報名 
            -->
            <div id="register" class="bg-white rounded-xl shadow-md overflow-hidden p-6 sm:p-8">
                <!-- [已修改] 將 h2 標題改為 flex 佈局，以容納人數上限提示 -->
                <div class="flex flex-wrap items-baseline gap-x-4 gap-y-2 mb-6">
                    <h2 class="text-3xl font-bold tracking-tight text-secondary-blue">線上報名</h2>
                    <!-- [修改] 此處的 class 和文字內容將由 JS 動態控制 -->
                    <span id="registrationStatus" class="text-xl font-medium text-gray-500">...</span>
                </div>
                
                <form id="registrationForm" class="space-y-5">
                    <!-- 姓名 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                        <div>
                            <label for="name" class="block text-sm font-medium text-secondary-blue">姓名</label>
                            <input type="text" name="name" id="name" required class="mt-1">
                        </div>
                        <!-- 人事號 -->
                        <div>
                            <label for="employeeId" class="block text-sm font-medium text-secondary-blue">人事號</label>
                            <input type="text" name="employeeId" id="employeeId" required class="mt-1">
                        </div>
                        <!-- 電子郵件 -->
                        <div>
                            <label for="email" class="block text-sm font-medium text-secondary-blue">電子郵件 (E-mail)</label>
                            <input type="email" name="email" id="email" required class="mt-1">
                        </div>
                        <!-- 連絡分機 -->
                        <div>
                            <label for="extension" class="block text-sm font-medium text-secondary-blue">連絡分機或簡碼</label>
                            <input type="text" name="extension" id="extension" class="mt-1">
                        </div>
                        <!-- 職類 -->
                        <div>
                            <label for="jobCategory" class="block text-sm font-medium text-secondary-blue">職類</label>
                            <select id="jobCategory" name="jobCategory" required class="mt-1">
                                <option value="">-- 請選擇您的職類 --</option>
                                <option value="西醫">西醫</option>
                                <option value="牙醫">牙醫</option>
                                <option value="中醫">中醫</option>
                                <option value="護理">護理</option>
                                <option value="藥事">藥事</option>
                                <option value="醫事放射">醫事放射</option>
                                <option value="醫事檢驗">醫事檢驗</option>
                                <option value="營養">營養</option>
                                <option value="呼吸治療">呼吸治療</option>
                                <option value="聽力">聽力</option>
                                <option value="職能治療">職能治療</option>
                                <option value="物理治療">物理治療</option>
                                <option value="臨床心理">臨床心理</option>
                                <option value="語言治療">語言治療</option>
                                <option value="行政人員">行政人員</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <!-- 臨床教學經驗 -->
                        <div>
                            <label for="experience" class="block text-sm font-medium text-secondary-blue">臨床教學經驗</label>
                            <select id="experience" name="experience" required class="mt-1">
                                <option value="">-- 請選擇您的資歷 --</option>
                                <option value="1-5年">1-5年</option>
                                <option value="5-10年">5-10年</option>
                                <option value="10年以上">10年以上</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 臨床教學職位 (可複選) -->
                    <div>
                        <label class="block text-sm font-medium text-secondary-blue">臨床教學職位 (可複選)</label>
                        <div class="mt-2 space-y-2 sm:space-y-0 sm:flex sm:space-x-6">
                            <div class="flex items-center">
                                <input id="role-head" name="role" type="checkbox" value="教學訓練計畫主持人" class="p-2">
                                <label for="role-head" class="ml-2 block text-sm text-gray-800">教學訓練計畫主持人</label>
                            </div>
                            <div class="flex items-center">
                                <input id="role-chief" name="role" type="checkbox" value="科部教學負責人" class="p-2">
                                <label for="role-chief" class="ml-2 block text-sm text-gray-800">科部教學負責人</label>
                            </div>
                            <div class="flex items-center">
                                <input id="role-teacher" name="role" type="checkbox" value="臨床教師" class="p-2">
                                <label for="role-teacher" class="ml-2 block text-sm text-gray-800">臨床教師</label>
                            </div>
                        </div>
                    </div>

                    <!-- 午餐 -->
                    <div>
                        <label class="block text-sm font-medium text-secondary-blue">午餐</label>
                        <div class="mt-2 space-y-2 sm:space-y-0 sm:flex sm:space-x-6">
                            <div class="flex items-center">
                                <input id="diet-meat" name="diet" type="radio" value="葷食" required class="p-2">
                                <label for="diet-meat" class="ml-2 block text-sm text-gray-800">葷食</label>
                            </div>
                            <div class="flex items-center">
                                <input id="diet-veg" name="diet" type="radio" value="素食" class="p-2">
                                <label for="diet-veg" class="ml-2 block text-sm text-gray-800">素食</label>
                            </div>
                            <div class="flex items-center">
                                <input id="diet-none" name="diet" type="radio" value="不需要" class="p-2">
                                <label for="diet-none" class="ml-2 block text-sm text-gray-800">不需要，可自理</label>
                            </div>
                        </div>
                    </div>

                    <!-- 報名按鈕區塊 -->
                    <div class="flex flex-col sm:flex-row gap-4 pt-4">
                        <button type="submit" id="submitButton" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-brick-red hover:bg-opacity-80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brick-red transition-colors duration-200">
                            <!-- [修改] 增加 Spinner 元素 -->
                            <span id="button-text">確認報名</span>
                            <svg id="spinner" class="animate-spin ml-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                        
                        <button type="button" id="googleCalendarButton" class="w-full sm:w-auto inline-flex justify-center items-center px-4 py-3 border border-gray-300 text-base font-medium rounded-md shadow-sm text-secondary-blue bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary-blue transition-colors duration-200">
                            <!-- SVG icon (calendar-days) -->
                            <svg class="w-5 h-5 mr-2 -ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                                <path d="M152 24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H64V24c0-13.3-10.7-24-24-24S16 10.7 16 24V64H0V448c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V64H336V24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H152V24zM0 192H448V448c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V192zm384-96H64v32H384V96z"/>
                            </svg>
                            加入 Google 行事曆
                        </button>
                    </div>
                </form>
                
                <!-- [加回] 報名成功提示框 (來自使用者圖片) -->
                <div id="successMessage" class="hidden mt-6 p-4 rounded-md bg-green-100 border border-green-300 text-green-800">
                    <h3 class="font-medium">報名成功！</h3>
                    <p>感謝您的報名，我們已收到您的資料。將會在會前2周內寄出分組名單及教案等資訊給您！</p>
                </div>
                
            </div>

            <!-- 
              區塊 3: 活動議程 (內容不變)
            -->
            <div id="agenda" class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="p-6 sm:p-8">
                  <h2 class="text-3xl font-bold tracking-tight text-secondary-blue mb-6">活動議程</h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full text-base">
                        <thead class="bg-deep-blue text-white">
                            <tr>
                                <th scope="col" class="py-3.5 px-4 text-left font-semibold">時間</th>
                                <th scope="col" class="py-3.5 px-4 text-left font-semibold">主題</th>
                                <th scope="col" class="py-3.5 px-4 text-left font-semibold">地點</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            
                            <tr class="bg-white">
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">09:00 - 09:10</td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-900 group relative">
                                    長官致詞
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">國際會議廳</td>
                            </tr>

                            <tr class="bg-light-khaki bg-opacity-40">
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">09:10 - 10:00</td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-900 group relative">
                                    Lecture：CCC核心概念
                                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs px-3 py-1.5 bg-deep-blue text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none">
                                        了解CCC運作
                                    </span>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">國際會議廳</td>
                            </tr>
                            
                            <tr class="bg-white">
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">10:00 - 10:10</td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-900 group relative">
                                    Coffee Break
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">-</td>
                            </tr>

                            <tr class="bg-light-khaki bg-opacity-40">
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">10:10 - 11:10</td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-900 group relative">
                                    CCC信賴評定演練
                                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs px-3 py-1.5 bg-deep-blue text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none">
                                        預計演練2個教案，委員解讀Portfolio並提出觀察、主席彙整意見、共同做出信賴評定
                                    </span>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">國際會議廳、552 會議室、554 會議室、556 會議室、558 會議室</td>
                            </tr>

                            <tr class="bg-white">
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">11:10 - 11:50</td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-900 group relative">
                                    結果分享與討論交流
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">國際會議廳</td>
                            </tr>

                            <tr class="bg-light-khaki bg-opacity-40">
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">11:50 - 13:00</td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-900 group relative">
                                    休息
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">-</td>
                            </tr>

                            <tr class="bg-white">
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">13:00 - 13:20</td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-900 group relative">
                                    Lecture：補強計畫說明
                                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs px-3 py-1.5 bg-deep-blue text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none">
                                        釐清問題、設定目標、選擇策略兼顧可行性
                                    </span>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">國際會議廳</td>
                            </tr>

                            <tr class="bg-light-khaki bg-opacity-40">
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">13:20 - 14:00</td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-900 group relative">
                                    補強計畫設計演練
                                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs px-3 py-1.5 bg-deep-blue text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none">
                                        針對上午學員CCC演練結果如何設計補強計畫
                                    </span>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">國際會議廳</td>
                            </tr>
                            
                            <tr class="bg-white">
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">14:00 - 14:10</td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-900 group relative">
                                    休息 / 換場
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">-</td>
                            </tr>

                            <tr class="bg-light-khaki bg-opacity-40">
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">14:10 - 14:40</td> 
                                <td class="px-4 py-4 whitespace-nowrap text-gray-900 group relative">
                                    Lecture：ADAPT回饋模組
                                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs px-3 py-1.5 bg-deep-blue text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none">
                                        介紹ADAPT回饋模組之概念講解、示範演練
                                    </span>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">國際會議廳</td>
                            </tr>

                            <tr class="bg-white">
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">14:40 - 15:30</td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-900 group relative">
                                    ADAPT回饋演練
                                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs px-3 py-1.5 bg-deep-blue text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none">
                                        各組中再分為2小組，輪流扮演教師與學員，進行回饋演練
                                    </span>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">國際會議廳</td>
                            </tr>

                            <tr class="bg-light-khaki bg-opacity-40">
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">15:30 - 16:00</td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-900 group relative">
                                    共識(各科下一步)與綜合討論
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-gray-700">國際會議廳</td>
                            </tr>

                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- 頁尾 -->
    <footer class="bg-deep-blue text-white mt-16 py-8">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm">
            <p>主辦單位：教學部</p>
            <p class="mt-1">聯絡人：楊宜婷 (分機: 57429；信箱: a80740@mail.chimei.org.tw)</p>
        </div>
    </footer>


    <!-- 
      [修改] JavaScript 程式碼 (完全採用 PGY 模式)
    -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- 1. 全域變數與 DOM 元素 ---
            
            // ！！至關重要！！
            // [已更新] 替換為您提供的 Apps Script URL
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyopfC_426aVcGXDNzzqO9mlPUqz8IUWEEfKHjYF3Hp7ebiWRffwvVhGNPVb5cmkBsFZA/exec"; 

            const form = document.getElementById('registrationForm');
            const submitButton = document.getElementById('submitButton');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');
            const registrationStatusEl = document.getElementById('registrationStatus');
            const toastBox = document.getElementById('toast-box');
            // [新增] 獲取靜態的成功訊息框
            const successMessage = document.getElementById('successMessage');


            // --- 2. 核心功能函式 (來自 PGY 範例) ---

            /**
             * [修改] 顯示 *錯誤* 浮動提示框
             * @param {string} text - 顯示的訊息
             */
            function showErrorToast(text) {
                toastBox.textContent = text;
                // 重設基礎樣式
                toastBox.className = 'p-4 rounded-xl font-bold transition-all duration-300 transform shadow-2xl min-w-[300px] text-center';
                // [修改] Gg-green-100', 'text-green-700'); // 綠色 (成功)
                toastBox.classList.add('bg-red-100', 'text-red-700'); // 紅色 (錯誤)

                // 觸發動畫
                toastBox.classList.remove('translate-y-[-150%]', 'opacity-0');
                toastBox.classList.add('translate-y-0', 'opacity-100');
                
                // 5 秒後自動隱藏
                setTimeout(() => {
                    toastBox.classList.remove('translate-y-0', 'opacity-100');
                    toastBox.classList.add('translate-y-[-150%]', 'opacity-0');
                }, 5000);
            }

            /**
             * 設定提交按鈕的狀態 (禁用/載入中/可用)
             * @param {boolean} isSubmitting - 是否正在提交
             * @param {string} [text] - 按鈕上顯示的文字
             */
            function setSubmitting(isSubmitting, text) {
                submitButton.disabled = isSubmitting;
                buttonText.textContent = text || (isSubmitting ? '處理中...' : '確認報名');
                spinner.classList.toggle('hidden', !isSubmitting);
            }

            /**
             * 禁用整個表單 (用於額滿時)
             */
            function disableForm() {
                setSubmitting(true, '報名已額滿');
                // 遍歷表單中所有輸入元素並禁用
                form.querySelectorAll('input, select, button').forEach(el => {
                    // 保留 "加入行事曆" 按鈕的功能
                    if (el.id !== 'googleCalendarButton') {
                        el.disabled = true;
                    }
                });
            }

            /**
             * 根據從 GAS 獲取的資料更新 UI
             * @param {object} data - 包含 status, count, limit 的物件
             */
            function updateCapacityUI(data) {
                if (!registrationStatusEl) return;

                if (data.status === 'open') {
                    // [修改] 根據使用者要求，不顯示剩餘名額，只顯示靜態文字
                    registrationStatusEl.textContent = '本活動上限60人'; 
                    registrationStatusEl.className = 'text-xl font-medium text-teal-600'; // 綠色 (開放)
                    setSubmitting(false, '確認報名'); // 確保按鈕可用
                } else if (data.status === 'closed') {
                    // [修改] 根據使用者要求，只顯示 "報名已額滿"
                    registrationStatusEl.textContent = '報名已額滿'; 
                    registrationStatusEl.className = 'text-xl font-medium text-red-600'; // 紅色 (額滿)
                    disableForm(); // 禁用表單
                }
            }

            /**
             * [GET] 檢查報名狀態
             */
            async function checkRegistrationStatus() {
                if (!registrationStatusEl) return;
                
                setSubmitting(true, '載入名額中...'); // 開始時禁用按鈕
                
                // [修改] 預設顯示靜態文字 "本活動上限60人"
                registrationStatusEl.textContent = '本活動上限60人'; 
                // [修改] 預設使用 "open" 的顏色 (teal-600)
                registrationStatusEl.className = 'text-xl font-medium text-teal-600'; 

                try {
                    // [修改] 遵循 PGY 模式，加入 ?action=checkCapacity
                    const response = await fetch(`${SCRIPT_URL}?action=checkCapacity`, { mode: 'cors' });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        // 成功獲取資料
                        updateCapacityUI(result.data);
                    } else {
                        // GAS 回傳 { success: false, ... }
                        throw new Error(result.message || '無法解析名額資料');
                    }
                } catch (error) {
                    console.error('Error fetching registration status:', error);
                    let errorMsg = '無法讀取報名狀態 (CORS 錯誤或網路連線失敗)。請確認 GAS 已正確「部署」為網頁應用程式，並允許「任何人」存取。';
                    // [修改] 呼叫 showErrorToast
                    showErrorToast(errorMsg);
                    // [修改] 錯誤時也更新 span 文字
                    registrationStatusEl.textContent = '讀取失敗 (請刷新)'; 
                    registrationStatusEl.className = 'text-xl font-medium text-red-600';
                    setSubmitting(true, '讀取失敗'); // 保持禁用
                }
            }
            
            // --- 3. 事件監聽 ---

            /**
             * [POST] 表單提交
             */
            form.addEventListener('submit', async function (e) {
                e.preventDefault(); // 防止表單的預設提交行為
                
                // [新增] 提交時，先隱藏舊的成功訊息
                if (successMessage) {
                    successMessage.classList.add('hidden');
                }

                setSubmitting(true, '報名資料送出中...');

                // [修改] 手動收集所有表單資料到一個物件，
                // 這是 PGY 範例的模式
                const data = {};
                const formData = new FormData(form);
                
                // 轉換 FormData 到
                for (const [key, value] of formData.entries()) {
                    // 處理複選框 (roles)
                    if (key === 'role') {
                        if (!data.roles) {
                            data.roles = []; // 初始化為陣列
                        }
                        data.roles.push(value);
                    } 
                    // 處理單選框 (diet)
                    else if (key === 'diet') {
                        // FormData 會自動抓取被選中的 radio
                        data.diet = value;
                    }
                    // 其他一般欄位
                    else {
                        data[key] = value;
                    }
                }
                
                // 確保 diet 至少有值 (如果 'required' 失效)
                if (!data.diet) {
                    data.diet = form.querySelector('input[name="diet"]:checked')?.value || '';
                }

                // [修改] 遵循 PGY 模式，打包成 payload
                const params = new URLSearchParams();
                params.append('payload', JSON.stringify(data));

                try {
                    const response = await fetch(SCRIPT_URL, { 
                        method: 'POST', 
                        mode: 'cors', // [修改] 保持 'cors'
                        body: params // [修改] body 內容
                    });
                    
                    // PGY 範例檢查 content-type，我們也照做
                    const contentType = response.headers.get("content-type");
                    if (!response.ok || !contentType || !contentType.includes("application/json")) {
                        const text = await response.text();
                         throw new Error(`伺服器回應格式錯誤: ${text || response.statusText}`);
                    }
                    
                    const result = await response.json(); // 解析 GAS 回傳的 JSON

                    if (result.success) {
                        // --- 報名成功 ---
                        // [修改] 改為顯示靜態的 successMessage div
                        if (successMessage) {
                            successMessage.classList.remove('hidden');
                            // 滾動到訊息位置
                            successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        form.reset();
                        // 成功後，GAS 會回傳最新狀態，我們用它來更新 UI
                        if (result.data) {
                            updateCapacityUI(result.data); // 這可能會直接禁用表單
                        }
                    } else {
                        // --- 報名失敗 (例如 GAS 內部錯誤或剛好額滿) ---
                        // [修改] 呼叫 showErrorToast
                        showErrorToast(`報名失敗：${result.message}`);
                        // 如果 GAS 回傳了最新狀態 (例如，額滿了)
                        if (result.data) {
                            updateCapacityUI(result.data);
                        } else {
                            // 只是提交錯誤，允許重試
                             setSubmitting(false, '確認報名');
                        }
                    }
                } catch (error) {
                    // --- 捕捉所有錯誤 (網路錯誤, fetch 錯誤, 或 .then() 拋出的錯誤) ---
                    console.error('Submit Error:', error);
                    let errorText = `資料送出時發生錯誤：${error.message}。請重新整理頁面再試。`;
                    if (error.message.includes('Failed to fetch')) {
                        errorText = '資料送出失敗 (CORS 錯誤或網路連線失敗)。請確認 Google Apps Script (GAS) 已正確部署並更新。';
                    }
                    // [修改] 呼叫 showErrorToast
                    showErrorToast(errorText);
                    setSubmitting(false, '確認報名'); // 允許重試
                }
            });

            // --- Google 行事曆邏輯 (保持不變) ---
            const googleCalendarButton = document.getElementById('googleCalendarButton');
            
            if (googleCalendarButton) {
                googleCalendarButton.addEventListener('click', function () {
                    
                    const event = {
                        title: "(CCC)臨床能力委員會實務工作坊",
                        startDate: "20251207T090000", // 2025-12-07 09:00
                        endDate: "20251207T160000",   // 2025-12-07 16:00
                        timeZone: "Asia/Taipei", 
                        location: "第五醫療大樓五樓國際會議廳、552會議室、554會議室、556會議室、558會議室",
                        description: "本次工作坊邀請臺大醫院楊志偉醫師指導，以CCC（Clinical Competency Committee，臨床能力評估委員會）之運作為主軸，強調信賴評定是以病人安全為核心的風險判斷而非單純分數評量。"
                    };

                    const baseUrl = "https://www.google.com/calendar/render?action=TEMPLATE";
                    const params = new URLSearchParams({
                        'text': event.title,
                        'dates': `${event.startDate}/${event.endDate}`,
                        'ctz': event.timeZone,
                        'details': event.description,
                        'location': event.location
                    });

                    const url = `${baseUrl}&${params.toString()}`;
                    window.open(url, '_blank');
                });
            }


            // --- 導覽列滾動偵測 (Scroll-Spy) 邏輯 (保持不變) ---
            const sections = document.querySelectorAll('main > div > div[id]');
            const navLinks = document.querySelectorAll('nav a[data-navlink]');
            const offset = 160; 

            function onScroll() {
                let current = '';
                
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    if (pageYOffset >= sectionTop - offset) {
                        current = section.getAttribute('id');
                    }
                });

                navLinks.forEach(link => {
                    link.classList.remove('text-brick-red', 'border-b-2', 'border-brick-red');
                    if (link.dataset.navlink === current) {
                        link.classList.add('text-brick-red', 'border-b-2', 'border-brick-red');
                    }
                });
            }
            
            window.addEventListener('scroll', onScroll);
            onScroll(); // 頁面載入時立即執行一次

            // --- 4. 程式進入點 ---
            checkRegistrationStatus();

        });
    </script>

</body>
</html>
